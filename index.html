<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity Web Player | ChristmasWebApp</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
</head>
<button onclick="startNfc()">Start NFC</button>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"></div>
        <div id="unity-footer">
            <div id="unity-logo-title-footer"></div>
            <div id="unity-fullscreen-button"></div>
            <div id="unity-build-title">ChristmasWebApp</div>
        </div>
    </div>

    <script>
let unityInstance = null;

// Unity loader callback
function onUnityLoaded(instance) {
    unityInstance = instance;
    console.log("Unity ready");
}

// PURE JS NFC HANDLER – no reload
async function startNfc() {
    if (!("NDEFReader" in window)) {
        console.error("Web NFC not supported");
        return;
    }

    try {
        const reader = new NDEFReader();
        await reader.scan();
        console.log("NFC scan started");

        reader.onreading = event => {
            let decoder = new TextDecoder();
            let text = "";

            for (const record of event.message.records) {
                if (record.recordType === "text") {
                    text = decoder.decode(record.data);
                }
            }

            console.log("NFC read:", text);
            sendNfcCommand(text);
        };

    } catch (e) {
        console.error("NFC ERROR:", e);
    }
}

// Function Unity will receive
function sendNfcCommand(cmd) {
    console.log("sendNfcCommand:", cmd);

    if (unityInstance) {
        unityInstance.SendMessage("Receiver", "OnNfc", cmd);
    } else {
        console.warn("Unity not ready");
    }
}

// For testing without NFC tag
function testNfc() {
    sendNfcCommand("TEST_PAYLOAD");
}
</script>

</body>
</html>
