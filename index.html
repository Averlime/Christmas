<script>
let unityInstance = null;

// Unity loader callback
function onUnityLoaded(instance) {
    unityInstance = instance;
    console.log("Unity ready");
}

// PURE JS NFC HANDLER – no reload
async function startNfc() {
    if (!("NDEFReader" in window)) {
        console.error("Web NFC not supported");
        return;
    }

    try {
        const reader = new NDEFReader();
        await reader.scan();
        console.log("NFC scan started");

        reader.onreading = event => {
            let decoder = new TextDecoder();
            let text = "";

            for (const record of event.message.records) {
                if (record.recordType === "text") {
                    text = decoder.decode(record.data);
                }
            }

            console.log("NFC read:", text);
            sendNfcCommand(text);
        };

    } catch (e) {
        console.error("NFC ERROR:", e);
    }
}

// Function Unity will receive
function sendNfcCommand(cmd) {
    console.log("sendNfcCommand:", cmd);

    if (unityInstance) {
        unityInstance.SendMessage("Receiver", "OnNfc", cmd);
    } else {
        console.warn("Unity not ready");
    }
}

// For testing without NFC tag
function testNfc() {
    sendNfcCommand("TEST_PAYLOAD");
}
</script>
